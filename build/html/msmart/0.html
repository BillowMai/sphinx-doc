<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>M-Smart相关 &mdash; msdk v1 文档</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/translations.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜索" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> msdk
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="在文档中搜索" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="index.html">msmart说明书</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">msdk</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>M-Smart相关</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/msmart/0.md.txt" rel="nofollow"> 查看页面源码</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="m-smart">
<h1>M-Smart相关<a class="headerlink" href="#m-smart" title="永久链接至标题"></a></h1>
<div class="section" id="sst">
<h2>SST - 智能设备安全传输承载协议<a class="headerlink" href="#sst" title="永久链接至标题"></a></h2>
<blockquote>
<div><p>文档见：M-Smart SST修改方案_20180307</p>
</div></blockquote>
<p>SST智能设备安全传输承载协议主要用于保障设备与云端、设备与APP之间以及设备与设备之间的安全传输</p>
</div>
<div class="section" id="fa">
<h2>FA配网<a class="headerlink" href="#fa" title="永久链接至标题"></a></h2>
<ol>
<li><p>从NAN通道(像极了NFC)获取配网信息，无需确权。</p></li>
<li><p>从鸿蒙UDP通道(AP模式)获取配网信息，需要确权。
(2021-01-21)</p></li>
<li><p>Hi-3861单wifi产品，自带鸿蒙系统，支持NAN，AP和UDP配网</p></li>
<li><p>对于WB01非鸿蒙系统，则需要移植FA SDK，并使用BLE或AP配网。</p>
<p>(2022-03-04)</p>
</li>
</ol>
</div>
<div class="section" id="license-mac">
<h2>License &amp; MAC<a class="headerlink" href="#license-mac" title="永久链接至标题"></a></h2>
<hr class="docutils" />
<p>License与IMEI或Wi-Fi/BLE MAC一一对应，烧录于模组，用于鉴别Midea产品和安全。1个MAC地址对应1个License。</p>
<p>License大小2kBytes, <strong>MAC</strong>地址位于Licnese中的指定位置, MSDK代码会在初始化时会自检。</p>
<p>申请流程：</p>
<ol class="simple">
<li><p>准备MAC地址列表</p></li>
<li><p>登录Midea License申请网站，提供MAC地址列表</p></li>
<li><p>Midea负责人审核并生成License列表及安全工具</p></li>
<li><p>将License下载到相应MAC地址的模组
(2021-04-07)</p></li>
</ol>
<p>License文件, 以MAC命名，502DBBF475F7.bin，名称中MAC地址为<strong>大端格式</strong>(高字节在前，低字节在后)</p>
<p>License内容，第[1:6]字节为MAC地址，同文件名，也是大端格式</p>
<p>nRF Connect软件， 显示扫描设备的MAC地址为大端格式</p>
<p>BLE标准MAC地址为小端格式，即0x502DBBF475F7   -&gt; F7 75 F4 BB 2D 50</p>
<p>BLE SDK适配层get_mac接口应按BLE标准顺序(小端)返回</p>
</div>
<div class="section" id="productkey">
<h2>ProductKey<a class="headerlink" href="#productkey" title="永久链接至标题"></a></h2>
<hr class="docutils" />
<p>产品KEY是在开发者平台创建产品时产生的(<strong>代表一个类型的产品??</strong>)
ProductKey和设备信息等会上报云端(开发者平台)做合法性验证，通过验证后才能进一步使用/调用模组内的MSDK广域网组件
建议用户加密存储</p>
<font color = red>
License ,ProductKey, SN 的区别：  
</font><blockquote>
<div><p>License是验证硬件合法性
ProductKey是验证产品合法性(一类产品)
SN码 分配给一个产品的</p>
</div></blockquote>
</div>
<div class="section" id="id1">
<h2>设备类型<a class="headerlink" href="#id1" title="永久链接至标题"></a></h2>
<p>device_type，四字节，由家电协议A0指令下发给模组，四字节含义如下：</p>
<table border="1" class="docutils">
<thead>
<tr>
<th>0</th>
<th>0-7</th>
<th>保留</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>0-7</td>
<td>家电主类型，按照标准的协议内的家电类型，框架的家电类型同时填写自己的类型  (品类码)</td>
</tr>
<tr>
<td>2</td>
<td>0-7</td>
<td>家电型号代码低字节，每个事业部不同的型号代码表可不同</td>
</tr>
<tr>
<td>3</td>
<td>0-7</td>
<td>家电型号代码高字节</td>
</tr>
</tbody>
</table></div>
<div class="section" id="sn-sn8">
<h2>SN &amp; SN8<a class="headerlink" href="#sn-sn8" title="永久链接至标题"></a></h2>
<p>SN码(32 bytes),  是创建产品后批量申请的，每个产品只能使用一个SN码, 美居通过SN码找到云端相应的产品信息和插件等。</p>
<p><strong>SN8(RSQ1111111)与SN的关系：</strong></p>
<p>:————————————————————————————:</p>
<p>SN                 ：          品类码             SN8              序列号             安全码
SN1（ASCII）： 000K    E2   341 RSQ11111   280000000         H5D9</p>
<p>SN2（ASCII）： 000K    E2   341 RSQ11111    280000001         M672</p>
<p>:                      |————–[0-27]:产品电子ID码————|–[28-31]安全码 –|</p>
<p>:————————————————————————————:</p>
<p>用SN8区分产品，通过SN8我们可以通过某些平台找到这个产品的信息</p>
<blockquote>
<div><p>SN前28字节为<strong>产品电子ID码</strong>，由阿拉伯数字0～9和大写英文字母A～Z（除去I，O）表示。</p>
<p>SN后4字节为<strong>安全码</strong>，由阿拉伯数字0-9和大小写英文字母A-Z、a-z表示。</p>
</div></blockquote>
</div>
<div class="section" id="ap">
<h2>AP热点名称规则<a class="headerlink" href="#ap" title="永久链接至标题"></a></h2>
<ul class="simple">
<li><p>售后模式的AP热点名称：midea_sh_xxxx 或 midea_test_xxxx， xxxx为空调WiFi模块的MAC地址最后4位，默认密码为：12345678</p></li>
<li><p>正常模式的AP热点名称：midea_xx_xxxx,  xx为品类码，xxxx为随机码</p></li>
<li><p>用户初始化时可自定义前缀(示例是midea)，非midea或bugu，最大长度为9字节。</p></li>
</ul>
</div>
<div class="section" id="ble">
<h2>BLE名称规则<a class="headerlink" href="#ble" title="永久链接至标题"></a></h2>
<p>BLE统一命名为midea，用户初始化时可自定义。</p>
</div>
<div class="section" id="sdk-0x0008">
<h2>SDK检验(0x0008命令)<a class="headerlink" href="#sdk-0x0008" title="永久链接至标题"></a></h2>
<table border="1" class="docutils">
<thead>
<tr>
<th>1字节</th>
<th>2字节</th>
<th>32字节</th>
<th>32字节</th>
<th>32字节</th>
</tr>
</thead>
<tbody>
<tr>
<td>品类</td>
<td>家电型号代码</td>
<td>设备SN</td>
<td>ProductKey</td>
<td>~~ProductSecret~~</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table><p>SDK校验只是NS校验产品的合法性，并不是校验SDK代码的完整性。
所以说，这些数据都要跟平台上的数据一致。</p>
</div>
<div class="section" id="id2">
<h2>绑定&amp;确权 - BLE<a class="headerlink" href="#id2" title="永久链接至标题"></a></h2>
<p>在配网过程中，用户产生确权动作后，设备才能绑定。</p>
</div>
<div class="section" id="id3">
<h2>数据备份 - BLE<a class="headerlink" href="#id3" title="永久链接至标题"></a></h2>
<p>收到64，分两种情况：</p>
<ol class="simple">
<li><p>切换模式，重新开始配网，且已前确权，10分钟内要完成配网。</p></li>
</ol>
<p>对于已绑定的设备，重新开始配网前，先保存当前配网信息，再开始新的配网。</p>
<p>当新的配网失败时，则<em><strong>恢复旧的配网信息</strong></em>。</p>
<p>当新的配网成功时，保存新的配网信息。</p>
<ol class="simple">
<li><p>确权，纯确权指令。</p></li>
</ol>
</div>
<div class="section" id="id4">
<h2>国家码与信道表<a class="headerlink" href="#id4" title="永久链接至标题"></a></h2>
<blockquote>
<div><p>资料：http://confluence.msmart.com/pages/viewpage.action?pageId=66153480</p>
<p>中国国家码及信道：https://blog.csdn.net/dxpqxb/article/details/80969760</p>
</div></blockquote>
<p>在BLE/AP配网过程中，配网信息帧包含了国家码和信道表（BLE 69指令，AP 0070指令）。</p>
<p>如果是新的国家，则需要事业部驻外人员联系当地厂商或无线管理局获取信道表，并提供云端同事，加入对该国家的支持。</p>
</div>
<div class="section" id="ota-msdk1-0">
<h2>OTA-MSDK1.0<a class="headerlink" href="#ota-msdk1-0" title="永久链接至标题"></a></h2>
<p>MSDK1.0只支持OTA V1, 不支持OTA V2.</p>
<p>SDK-&gt;用户事件:</p>
<p><code class="docutils literal notranslate"><span class="pre">ENUM_MS_NETAPP_EVENT_REQUEST_NEW_VERSION</span></code> - 升级版本信息推送</p>
<blockquote>
<div><ul class="simple">
<li><p>OTA-V1:模组静默升级，仅支持多媒体固件升级方式，检测是否有升级包的时序：测服1分钟/2分钟检测，生产15分钟/24小时检测.</p></li>
</ul>
<p>注1：开发者获取到URL后，自行通过Http协议下载固件；
注2：为确保安全，开发者需对欲下载固件的合法性及完整性做校验</p>
</div></blockquote>
<p>相关示例代码：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>ms_net_test.c:
case: ENUM_MS_NETAPP_EVENT_REQUEST_NEW_VERSION
  MS_TRACE(&quot;you need upgrade now!!!&quot;);
  MS_TRACE(&quot;version is&quot;);
  PRINT_BUF(version, version_len);
  MS_TRACE(&quot;url is&quot;);      ///获得固件url下载地址（用户自行下载固件，并自行实现升级逻辑）
  PRINT_BUF(url, url_len);
  MS_TRACE(&quot;md5 is&quot;);
  PRINT_BUF(md5, md5_len);
</pre></div>
</div>
</div>
<div class="section" id="id5">
<h2>固件基线版本要求<a class="headerlink" href="#id5" title="永久链接至标题"></a></h2>
<p>即新需求基于哪个固件版本进行开发，外部需求由需求方提出，产品经
理审核；通用固件由产品经理定义</p>
<blockquote>
<div><p>固件版本是否有格式说明？TODO</p>
</div></blockquote>
</div>
<div class="section" id="sn-cvv">
<h2>SN  &amp; CVV校验<a class="headerlink" href="#sn-cvv" title="永久链接至标题"></a></h2>
<p>CVV校验作用是防止非法设备接入美的云</p>
<p>SN编码规则：（文档见：QM-J010.0014-2021 终端产品条码规则(原标准号：QM-J010.0014-2020).doc）</p>
<p><img alt="msmart/image/MSmart%E5%8A%9F%E8%83%BD%E5%88%97%E8%A1%A8/image-20211015113429441.png" src="msmart/image/MSmart%E5%8A%9F%E8%83%BD%E5%88%97%E8%A1%A8/image-20211015113429441.png" /></p>
<p>长度：  -(4)   品类码(2)   - (3)    SN8(8)             生产日期(4)    序列(7)      安全码(4)</p>
<p>字节：  1-4     5-6             7-9     10-17               18-21             22-28              29-32</p>
<p>SN  ： 8710    14             310    ETA35001         1728              0000000        YGTP</p>
<p>智能连接内部测试SN划分：</p>
<ul class="simple">
<li><p>SN内32位字符的第19位为月份，取值范围：0-9/A/B/C，该范围为集团SN标准规范内的使用范围，避开此范围即可。</p></li>
<li><p>为避免各团队使用SN冲突风险，SN第19位固定为：研发-“0”（数字），研测-“T”，品测-“Z”，FAE - “F”</p></li>
</ul>
<blockquote>
<div><p>给其它事业部测试用的SN:  000012111Q10000001 F 41 DEM0 018 0000</p>
</div></blockquote>
<blockquote>
<div><p>SN码，总长度32bytes, 根据代码判断，SVV做了以下校验：</p>
<p>[0-27] : 28bytes,  产品电子ID码，由阿拉伯数字0～9和大写英文字母A～Z（除去I，O）表示。</p>
<p>[28-31] : 4bytes, 安全码，由阿拉伯数字0-9和大小写英文字母A-Z、a-z表示。</p>
</div></blockquote>
</div>
<div class="section" id="sn">
<h2>售后反写SN功能<a class="headerlink" href="#sn" title="永久链接至标题"></a></h2>
<p>(实际是：重写SN/重绑SN)</p>
<p>售后APP可以重新给电控板写入SN功能</p>
<p>PRD: 智能产品支持更换主板后在新主板写入SN或重绑SN，具有写入SN或重绑SN功能，确保智能产品能继续正常使用。</p>
<p>反写SN大致流程：电控按键/遥控器-&gt;WIFI模组进入售后模式-&gt;起热点(AP)-&gt;手机售后软件连接热点-&gt;手机发送新SN指令(cmd=0020透传)-&gt;WIFI模组收到并透传给电控(cmd=0F空调SN查询/写入)-&gt;电控保存-&gt;重启。</p>
<p>代码相关：aftersales</p>
<p>msmart2.0 application自带</p>
</div>
<div class="section" id="id6">
<h2>7变3<a class="headerlink" href="#id6" title="永久链接至标题"></a></h2>
<p>7变3是指，<strong>配网</strong>过程中，7个步骤合并成3个，提高配网成功率和用户体验</p>
<ul class="simple">
<li><p>若美居已下载过插件页(页面控件) - 3步</p>
<ol class="simple">
<li><p>添加设备，登录美居并扫描设备二维码</p></li>
<li><p>连接设备</p></li>
<li><p>配网完成</p></li>
</ol>
</li>
<li><p>若美居未下载过插件页(新用户) - 7步</p>
<ol class="simple">
<li><p>添加设备，登录美居并扫描设备二维码</p></li>
<li><p>连接设备</p></li>
<li><p>配网完成</p></li>
<li><p>进入美居，加载插件</p></li>
<li><p>美居自动下载插件(即显示出设备图片)</p></li>
<li><p>美居提示确权</p></li>
<li><p>设备确权(按键确定)</p></li>
</ol>
</li>
</ul>
<blockquote>
<div><p>7-正常配网需要7步</p>
<p>3-即通过设备二维码配网只需3步（貌似跟7步没啥关系）</p>
</div></blockquote>
</div>
<div class="section" id="wifi">
<h2>WIFI靠近配网<a class="headerlink" href="#wifi" title="永久链接至标题"></a></h2>
</div>
<div class="section" id="id7">
<h2>蓝牙一键配网<a class="headerlink" href="#id7" title="永久链接至标题"></a></h2>
</div>
<div class="section" id="id8">
<h2>蓝牙直连控制<a class="headerlink" href="#id8" title="永久链接至标题"></a></h2>
<hr class="docutils" />
<p>（M-Smart标准协议，优先支持美居）</p>
</div>
<div class="section" id="nt-oppo">
<h2>NT无感配网-OPPO手机<a class="headerlink" href="#nt-oppo" title="永久链接至标题"></a></h2>
<hr class="docutils" />
<p>模组WIFI广播指定信息，手机获取广播信息，并从云端获取预设密钥，使用预设密钥，下发SSID配网信息给模组，模组使用预设密钥解密，获取配网信息，并配网。</p>
<p>目前，支持OPPO手机，涉及概念：云云交互。详见《NT无感配网.md》</p>
<ul class="simple">
<li><p>流程理解</p></li>
</ul>
<p>1, 设备WIFI广播， OPPO手机检测到后，发到OPPO云，OPPO云与美的云“云云交互”，OPPO手机获得设备公钥。</p>
<p>2, OPPO手机将配网信息( SSID,KEY)+手机公钥(明文）+ （美的字段+ 设备数字签名“OK”）（设备公钥加密密文）等发给设备。</p>
<p>3, 设备用设备私钥解密数字签名段，验证成功。</p>
<p>4, 设备入网。</p>
<p>5, 设备用手机公钥加密数据上报OPPO手机。</p>
<ul class="simple">
<li><p>通信安全</p></li>
</ul>
<p>预设密钥，存储在设备端和云端，设备端用于生成设备私钥，云端用于生成设备公钥(给OPPO用）</p>
<blockquote>
<div><p>设备端：设备预设密钥，存在设备FLASH中，采用指定算法，可计算出设备密钥。</p>
<p>美居APP-SDK： 存储/或从云端获取8组设备公钥派生。当OPPO手机底层需要时，传给OPPO手机底层。</p>
</div></blockquote>
<p>设备广播, 带随机密钥组号(0-7) （我猜，应该是BLE广播帧长度限制，不能在广播中携带设备公钥）</p>
<p>OPPO跟SDK获取设备公钥</p>
<p>OPPO手机将配网信息( SSID,KEY)+手机公钥(明文）+ （美的字段+ 设备数字签名“OK”）（设备公钥加密密文）等发给设备。</p>
<p>设备用设备私钥解密数字签名段，验证成功。并存储OPPO公钥，完成密钥交换。</p>
<p>（以上为大概猜测）</p>
</div>
<div class="section" id="id9">
<h2>鸿蒙FA配网<a class="headerlink" href="#id9" title="永久链接至标题"></a></h2>
</div>
<hr class="docutils" />
<div class="section" id="udp">
<h2>UDP配网功能<a class="headerlink" href="#udp" title="永久链接至标题"></a></h2>
<hr class="docutils" />
<p>当前微信UDP接口免费开放，TCP接口收费。集团战略规划在微信小程序上增加配网功能，
如果使用TCP通道配网则需要每年向微信支付200万元。
为了解决微信这种卡脖问题，计划通过UDP通道配网。</p>
<p>大致流程：</p>
<ol class="simple">
<li><p>模组起热点</p></li>
<li><p>APP连接热点，通过007A查看模组是否具备UDP配网功能。</p></li>
<li><p>APP通过UDP发送配网信息</p></li>
<li><p>模组切换到STA，并连接云端，<strong>发起设备绑定流程</strong></p></li>
</ol>
<blockquote>
<div><p>UDP配网功能与正常的TCP配网功能相比，主要区别在于，UDP配网的设备绑定流程发送在模组和云端之间，而TCP配网的设备绑定流程发生在模组与APP之间</p>
</div></blockquote>
</div>
<div class="section" id="ads">
<h2>ADS服务器切换<a class="headerlink" href="#ads" title="永久链接至标题"></a></h2>
<p>云端新增服务:ADS(apply domain_name server），用于给模组提供获取有效登录接入层的域名，服务可以扩展到多个集群中心，支撑亿级连接。</p>
<p>流程及关键指令：</p>
<ol class="simple">
<li><p>0x0050 -模组配置参数上报， 模组告知APP自己有ADS功能</p></li>
<li><p>0x0070 -设备入网(TCP)-，APP下发服务器域名给模组</p></li>
</ol>
</div>
<div class="section" id="id10">
<h2>波特率协商<a class="headerlink" href="#id10" title="永久链接至标题"></a></h2>
<hr class="docutils" />
<p>关键串口指令-波特率协商指令：0x1D-0x00/01/02/03</p>
<table border="1" class="docutils">
<thead>
<tr>
<th>0x01</th>
<th>电控 ——&gt; 模块</th>
<th>电控请求协商波特率</th>
</tr>
</thead>
<tbody>
<tr>
<td>0x01</td>
<td>电控 ——&gt; 模块</td>
<td>电控请求确认波特率协商</td>
</tr>
<tr>
<td>0x02</td>
<td>电控 ——&gt; 模块</td>
<td>电控确认完成波特率协商</td>
</tr>
<tr>
<td>0x03</td>
<td>电控 ——&gt; 模块</td>
<td>心跳包</td>
</tr>
</tbody>
</table></div>
<div class="section" id="id11">
<h2>支持云端环境切换<a class="headerlink" href="#id11" title="永久链接至标题"></a></h2>
<hr class="docutils" />
<p>msmart v2.2版本新增WPS功能，取代了该云端环境切换功能。</p>
</div>
<div class="section" id="id12">
<h2>防误触功能<a class="headerlink" href="#id12" title="永久链接至标题"></a></h2>
</div>
<hr class="docutils" />
<div class="section" id="otaota">
<h2>电控OTA和模组OTA资料库<a class="headerlink" href="#otaota" title="永久链接至标题"></a></h2>
<ul class="simple">
<li><p>模组OTA固件版本号标准文档：</p></li>
</ul>
<blockquote>
<div><p>MSmart-Public-IoT_事业部模组文档同步\01.软件\04.固件版本号管控及标识码申请表</p>
<p>美集IoT字[2019]073号 关于模组固件版本号管控的通知.doc</p>
</div></blockquote>
<ul>
<li><p>电控OTA固件版本号参考：</p>
<blockquote>
<div><p>MSmart-Public-IoT_事业部模组文档同步\01.软件\07.电控OTA协议文档\电控OTA版本号规则定义（2021年5月26日更新）</p>
<p>电控OTA版本号规则定义(2021年5月26日更新).pdf</p>
</div></blockquote>
</li>
</ul>
<p>备注：研发叶楚汉提供的模组OTA固件版本号前3字节，如120004，后3字节由用户定义，云端只判断前6字节，小版本号不判断。</p>
</div>
<div class="section" id="ota-sst-https">
<h2>OTA安全-SST &amp; Https<a class="headerlink" href="#ota-sst-https" title="永久链接至标题"></a></h2>
<hr class="docutils" />
<p>OTA安全有两个功能选择 SST 和 Https, 分别由两个宏控制。</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">MS_OTA_USE_SECURE</span></code> - 默认为true</p></li>
</ul>
<p>涉及指令： 模块上报安全功能版本号子命令-0x0051</p>
<p>模组上报1）自身是否支持固件完整性认证或签名认证功能，2）自身是否支持https</p>
<p>云端根据模组能力(0051)，下发指定的url（http或https），下发认证信息等。</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">MS_OTA_HTTPS_SUPPORT</span></code> - 可选</p></li>
</ul>
<p>涉及指令： 模块上报安全功能版本号子命令-0x0051</p>
<p>云端根据模组能力(0051)，下发指定的url（http或https）</p>
<blockquote>
<div><ul class="simple">
<li><p>MS_OTA_USE_SECURE &amp; MS_OTA_HTTPS_SUPPORT 如何选？</p></li>
</ul>
<p>1）使能MS_OTA_USE_SECURE后，固件完整性已有保障，MS_OTA_HTTPS_SUPPORT可选可不选。</p>
<p>2）不使能MS_OTA_USE_SECURE，固件完整性无保障，MS_OTA_HTTPS_SUPPORT可不选(因为选了也没用，数据安全了，但完整性无保障)</p>
</div></blockquote>
</div>
<div class="section" id="ota-ota">
<h2>OTA升级 - 局域网模组固件OTA<a class="headerlink" href="#ota-ota" title="永久链接至标题"></a></h2>
</div>
<hr class="docutils" />
<div class="section" id="id13">
<h2>OTA升级 - 广域网模组固件OTA<a class="headerlink" href="#id13" title="永久链接至标题"></a></h2>
</div>
<hr class="docutils" />
<div class="section" id="id14">
<h2>OTA升级 - 电控OTA<a class="headerlink" href="#id14" title="永久链接至标题"></a></h2>
</div>
<hr class="docutils" />
<div class="section" id="ota-ota-a-b">
<h2>OTA升级 - 电控OTA - A/B分区<a class="headerlink" href="#ota-ota-a-b" title="永久链接至标题"></a></h2>
</div>
<hr class="docutils" />
<div class="section" id="id15">
<h2>OTA升级 - 电控OTA - 单分区<a class="headerlink" href="#id15" title="永久链接至标题"></a></h2>
<hr class="docutils" />
<p>模组通知家电下载文件-子命令：90-02， 模组回复内容<strong>0x02：切换时下载</strong> 表示电控为单区</p>
<p>模组上报0002-0047，通知云端和美居已缓存新固件，美居提示用户可选择新固件。</p>
<div class="highlight-sequence notranslate"><div class="highlight"><pre><span></span>title: 电控OTA
电控--&gt;模组:
模组--&gt;云端:
云端--&gt;美居:

模组-&gt;电控:90-02
电控--&gt;模组:90-02:\n 02：切换时下载, 表示电控为单区

模组-&gt;云端: 0002-0047:通知模组已缓存新固件
云端-&gt;美居: 通知美居
美居-&gt;美居: 界面显示有可用新固件

</pre></div>
</div>
</div>
<div class="section" id="id16">
<h2>OTA升级 - 产线OTA<a class="headerlink" href="#id16" title="永久链接至标题"></a></h2>
</div>
<hr class="docutils" />
<div class="section" id="id17">
<h2>自动切换接入云服务器<a class="headerlink" href="#id17" title="永久链接至标题"></a></h2>
</div>
<hr class="docutils" />
<div class="section" id="id18">
<h2>美的AP信息<a class="headerlink" href="#id18" title="永久链接至标题"></a></h2>
<hr class="docutils" />
<ul class="simple">
<li><p>默认AP信道                                                       1</p></li>
<li><p>默认AP SSID名称                                              midea_品类_SN</p></li>
<li><p>默认AP密码                                                      12345678</p></li>
<li><p>xxx到起AP时间                                                  7s</p></li>
<li><p>配网后，重连路由，默认连接RSSI最强的同名热点             是</p></li>
<li><p>支持5G SSID的模糊匹配                                                   是</p></li>
<li><p>平均配网时长（从进入美居配网进度条到美居提示完成)     15s</p></li>
<li><p>需要达到的配网成功率（美的AP模式/BLE模式）               98%</p></li>
<li><p>（WIFI+BLE模组）上电后，Wi-Fi默认
为AP，蓝牙确权后，AP有效时间                                      10min</p></li>
<li><p>（WIFI+BLE模组）上电后，Wi-Fi默认
为AP，蓝牙确权后，蓝牙配网的有效
时间                                                                                 60min</p></li>
<li><p>（WIFI+BLE模组）上电后，确权前的
蓝牙广播有效时间                                                             60min</p></li>
</ul>
</div>
<div class="section" id="id19">
<h2>蓝牙功能<a class="headerlink" href="#id19" title="永久链接至标题"></a></h2>
<hr class="docutils" />
<ul class="simple">
<li><p>默认蓝牙设备名称                                            midea</p></li>
<li><p>最大通信数据包                                               128Byte</p></li>
<li><p>手机通过蓝牙直连数据透传功能（控制
、查询、上报）                                               是
*</p></li>
</ul>
</div>
<div class="section" id="id20">
<h2>三端日志<a class="headerlink" href="#id20" title="永久链接至标题"></a></h2>
<p>三端日志记录配网及网络方面异常问题</p>
<ul>
<li><p>指令为：0055</p></li>
<li><p>工具有，三端日志解析工具，instructions_0055.exe。用法：在开发者平台管理后台，通过SN查看日志，找到异常时间之后的0055指令，复制指令内容到解析工具，查看解析结果。</p>
<blockquote>
<div><p>通过平台日志可以看到完整net交互命令。</p>
</div></blockquote>
</li>
</ul>
</div>
<div class="section" id="id21">
<h2>全链路埋点<a class="headerlink" href="#id21" title="永久链接至标题"></a></h2>
<p>代码中的埋点列表：<code class="docutils literal notranslate"><span class="pre">E_MsControlLinkErrorCode</span></code></p>
<p>主要用于记录内部链路状态，比如用于统计透传数据成功率。</p>
</div>
<div class="section" id="id22">
<h2>错误码<a class="headerlink" href="#id22" title="永久链接至标题"></a></h2>
<p>由errcode(错误码)组件提供相关功能，主要用于记录配网失败原因</p>
<p>文档见：错误码映射.xlsx</p>
</div>
</div>
<div class="section" id="bytes">
<h1>模组固件版本号规范(9bytes)<a class="headerlink" href="#bytes" title="永久链接至标题"></a></h1>
<blockquote>
<div><p>资料：模组固件版本号管控.doc</p>
<p>串口获取固件版本号指令-87指令</p>
<p>固件版本号格式, 由IOT和事业部各自定义一部分，用于OTA升级</p>
</div></blockquote>
<p>示例：070102042000000026</p>
<p>即： 07 0102 - 042000 - 000026</p>
<p>固件版本格式：</p>
<p><strong>IoT定义</strong>：</p>
<p>07 - 固件标识码</p>
<p>0102 - 硬件及协议栈配置信息</p>
<p><strong>事业部定义</strong>：</p>
<p>04 - 软件版本</p>
<p>20 - 软件发布日期-年</p>
<p>00 - 软件发布日期-周</p>
<p><strong>开发记录版本</strong>（云端不识别）：</p>
<p>00 - 框架版本</p>
<p>00 - 功能增加</p>
<p>26 - 缺陷修改</p>
</div>
<div class="section" id="id23">
<h1>本地联动-不可连接广播 - BLE<a class="headerlink" href="#id23" title="永久链接至标题"></a></h1>
<blockquote>
<div><p>日志关键字：</p>
<p>ms_ble_rc4_crypt|-&gt;:</p>
<p>ms_ble_scan_nonconn_adv_parse|rc4 Pre-processing data|mac]</p>
</div></blockquote>
<p>数据帧格式：</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/*业务层*/</span>
<span class="k">typedef</span> <span class="k">struct</span>
<span class="p">{</span>
    <span class="kt">uint8_t</span> <span class="n">bf_type</span><span class="p">;</span>   <span class="c1">//业务类型 - 0x01</span>
    <span class="kt">uint8_t</span> <span class="n">bf_ver</span><span class="p">;</span>    <span class="c1">//业务类型版本 - 0x01</span>
    <span class="kt">uint8_t</span> <span class="n">category</span><span class="p">;</span>  <span class="c1">//品类码</span>
    <span class="kt">uint8_t</span> <span class="n">adv_type</span><span class="p">;</span>  <span class="c1">//广播类型： 0-数据广播 1-配对广播</span>
    <span class="kt">uint8_t</span> <span class="n">data</span><span class="p">[];</span>    <span class="c1">//用户数据</span>
<span class="p">}</span> <span class="n">ms_ble_nonconn_adv_bfp_data_t</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/*完整的广播帧内容，31字节*/</span>
<span class="k">typedef</span> <span class="k">struct</span>
<span class="p">{</span>
    <span class="kt">uint8_t</span> <span class="n">ad_len</span><span class="p">;</span>        <span class="c1">//!&lt; adv data len or scan rsp data len</span>
    <span class="kt">uint8_t</span> <span class="n">ad_type</span><span class="p">;</span>       <span class="c1">//广播类型： 0x16 - 服务数据 （0x01-蓝牙类型标识，0xFF-厂家自定义）</span>
    <span class="kt">uint8_t</span> <span class="n">ad_uuid</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>    <span class="c1">//0xFD24 - 应用数据交互使用，如电控透传等</span>
    <span class="kt">uint8_t</span> <span class="n">sm_type</span><span class="p">;</span>       <span class="c1">//0x02 - RC4加解密算法</span>
    <span class="kt">uint8_t</span> <span class="n">sm_ver</span><span class="p">;</span>        <span class="c1">//0x00 - 默认</span>
    <span class="kt">uint8_t</span> <span class="n">tid</span><span class="p">;</span>           <span class="c1">//MID 重放校验 - 帧计数 （1~255）</span>
    <span class="kt">uint8_t</span> <span class="n">rc4</span><span class="p">[];</span>         <span class="c1">//业务层数据(加密) - 见上面结构体：ms_ble_nonconn_adv_bfp_data_t</span>
<span class="p">}</span> <span class="n">ms_ble_nonconn_adv_data_t</span><span class="p">;</span>
</pre></div>
</div>
<p>字节长度：7+{4+n} = 11+n，(n&lt;16)</p>
<p>举例：一个模组广播数据，一个模组扫描数据，如果带业务层数据，接收端会解密，并打印MAC地址。如果不带业务数据，则不会打印MAC地址，需注意这点。</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">///发送端</span>
<span class="p">[</span><span class="n">rc4</span> <span class="n">Pre</span><span class="o">-</span><span class="n">processing</span> <span class="n">data</span><span class="p">][</span><span class="mi">14</span><span class="p">]</span><span class="o">-&gt;:</span>            <span class="mo">01</span> <span class="mo">01</span> <span class="n">c0</span> <span class="mo">00</span> <span class="mo">01</span> <span class="mo">02</span> <span class="mo">03</span> <span class="mo">04</span> <span class="mo">05</span> <span class="mo">06</span> <span class="mo">07</span> <span class="mi">08</span> <span class="mi">09</span> <span class="mi">0</span><span class="n">a</span> <span class="c1">//原始业务数据</span>
<span class="p">[</span><span class="n">rc4</span> <span class="n">Processed</span> <span class="n">data</span><span class="p">][</span><span class="mi">14</span><span class="p">]</span><span class="o">-&gt;:</span>                 <span class="mi">0</span><span class="n">b</span> <span class="mi">8</span><span class="n">e</span> <span class="mf">2f</span> <span class="mo">03</span> <span class="mi">60</span> <span class="mi">6</span><span class="n">a</span> <span class="mi">4</span><span class="n">e</span> <span class="n">fa</span> <span class="n">ba</span> <span class="n">ad</span> <span class="mi">6</span><span class="n">b</span> <span class="mi">74</span> <span class="n">b0</span> <span class="mf">6f</span> <span class="c1">//业务数据加密</span>
<span class="p">[</span><span class="n">nonconn</span> <span class="n">adv</span><span class="p">][</span><span class="mi">21</span><span class="p">]</span><span class="o">-&gt;:</span> <span class="mi">14</span> <span class="mi">16</span> <span class="mi">24</span> <span class="n">fd</span> <span class="mo">02</span> <span class="mo">00</span> <span class="mo">01</span>   <span class="mi">0</span><span class="n">b</span> <span class="mi">8</span><span class="n">e</span> <span class="mf">2f</span> <span class="mo">03</span> <span class="mi">60</span> <span class="mi">6</span><span class="n">a</span> <span class="mi">4</span><span class="n">e</span> <span class="n">fa</span> <span class="n">ba</span> <span class="n">ad</span> <span class="mi">6</span><span class="n">b</span> <span class="mi">74</span> <span class="n">b0</span> <span class="mf">6f</span> <span class="c1">//完整广播帧</span>
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">///接收端</span>
<span class="o">&lt;</span><span class="n">D</span><span class="o">&gt;</span><span class="n">ms</span> <span class="p">[</span><span class="n">Task_B</span><span class="p">]</span><span class="o">:</span><span class="n">ms_ble_app_scan_data_process</span> <span class="n">m_node</span> <span class="mf">20f</span><span class="n">d3088</span>
<span class="p">[</span><span class="n">D</span><span class="p">]</span> <span class="p">[</span><span class="n">BLE_SCAN</span><span class="p">]</span> <span class="o">:</span> <span class="n">ms_ble_scan_nonconn_adv_parse</span>
<span class="p">[</span><span class="n">D</span><span class="p">]</span> <span class="p">[</span><span class="n">BLE_RC4</span><span class="p">]</span> <span class="o">:</span> <span class="n">ms_ble_rc4_crypt</span>
<span class="p">[</span><span class="n">rc4</span> <span class="n">K1</span><span class="p">][</span><span class="mi">8</span><span class="p">]</span><span class="o">-&gt;:</span> <span class="mi">3</span><span class="n">d</span> <span class="n">d5</span> <span class="mi">21</span> <span class="mi">1</span><span class="n">b</span> <span class="n">e8</span> <span class="mi">08</span> <span class="mi">10</span> <span class="n">da</span> 
<span class="p">[</span><span class="n">rc4</span> <span class="n">Pre</span><span class="o">-</span><span class="n">processing</span> <span class="n">data</span><span class="p">][</span><span class="mi">14</span><span class="p">]</span><span class="o">-&gt;:</span>           <span class="mi">0</span><span class="n">b</span> <span class="mi">8</span><span class="n">e</span> <span class="mf">2f</span> <span class="mo">03</span> <span class="mi">60</span> <span class="mi">6</span><span class="n">a</span> <span class="mi">4</span><span class="n">e</span> <span class="n">fa</span> <span class="n">ba</span> <span class="n">ad</span> <span class="mi">6</span><span class="n">b</span> <span class="mi">74</span> <span class="n">b0</span> <span class="mf">6f</span> <span class="c1">//业务数据-已加密</span>
<span class="p">[</span><span class="n">rc4</span> <span class="n">Processed</span> <span class="n">data</span><span class="p">][</span><span class="mi">14</span><span class="p">]</span><span class="o">-&gt;:</span>                <span class="mo">01</span> <span class="mo">01</span> <span class="n">c0</span> <span class="mo">00</span> <span class="mo">01</span> <span class="mo">02</span> <span class="mo">03</span> <span class="mo">04</span> <span class="mo">05</span> <span class="mo">06</span> <span class="mo">07</span> <span class="mi">08</span> <span class="mi">09</span> <span class="mi">0</span><span class="n">a</span> <span class="c1">//原始业务数据-已解密</span>
<span class="p">[</span><span class="n">D</span><span class="p">]</span> <span class="p">[</span><span class="n">BLE_SCAN</span><span class="p">]</span> <span class="o">:</span> <span class="n">category</span> <span class="n">c0</span>
<span class="p">[</span><span class="n">D</span><span class="p">]</span> <span class="p">[</span><span class="n">BLE_SCAN</span><span class="p">]</span> <span class="o">:</span> <span class="n">rssi</span> <span class="o">-</span><span class="mi">46</span>
<span class="p">[</span><span class="n">D</span><span class="p">]</span> <span class="p">[</span><span class="n">BLE_SCAN</span><span class="p">]</span> <span class="o">:</span> <span class="n">tid</span> <span class="mi">1</span>
<span class="p">[</span><span class="n">D</span><span class="p">]</span> <span class="p">[</span><span class="n">BLE_SCAN</span><span class="p">]</span> <span class="o">:</span> <span class="n">adv_type</span> <span class="mi">0</span>
<span class="p">[</span><span class="n">mac</span><span class="p">][</span><span class="mi">6</span><span class="p">]</span><span class="o">-&gt;:</span> <span class="n">da</span> <span class="mi">10</span> <span class="mi">08</span> <span class="n">e8</span> <span class="mi">3</span><span class="n">a</span> <span class="mi">2</span><span class="n">c</span>    <span class="c1">//对应的MAC地址</span>
<span class="p">[</span><span class="n">controler</span> <span class="n">data</span><span class="p">][</span><span class="mi">10</span><span class="p">]</span><span class="o">-&gt;:</span> <span class="mo">01</span> <span class="mo">02</span> <span class="mo">03</span> <span class="mo">04</span> <span class="mo">05</span> <span class="mo">06</span> <span class="mo">07</span> <span class="mi">08</span> <span class="mi">09</span> <span class="mi">0</span><span class="n">a</span> <span class="c1">//用户数据</span>
</pre></div>
</div>
<div class="section" id="id24">
<h2>操作流程<a class="headerlink" href="#id24" title="永久链接至标题"></a></h2>
<ol class="simple">
<li><p>测试1</p></li>
</ol>
<p>设备A发送配对广播，设备B扫描设备A的配对广播（指定MAC），下面是设备B的电控日志：</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span>[2021-12-28 11:18:30.391] 发送数据: 
AA 16 FF E9 00 00 00 00 00 21 03 01 01 06 00 06 A3 1C 22 93 20 3C 00  //开启配对广播扫描，扫描对端的MAC地址为：A3 1C 22 93 20 3C

[2021-12-28 11:18:30.504] 收到数据：
AA 0C FC F0 00 00 00 00 00 21 03 00 E4 

[2021-12-28 11:18:30.674] 收到数据：
AA 1E FC E2 00 00 04 00 00 0D 01 03 00 01 01 A8 C0 00 01 01 00 00 00 03 00 00 01 00 00 00 7F //状态通知, 已开启扫描
消息类型：模组联网状态通知
蓝牙状态：已开启可连接广播 已开启扫描  

[2021-12-28 11:18:30.791] 收到数据：
AA 1F FC E3 00 00 05 00 00 21 11 01 FC A3 1C 22 93 20 3C D6 0A 01 02 03 04 05 06 07 08 09 0A E7 //已扫描到设备A3 1C 22 93 20 3C的配对广播
</pre></div>
</div>
<ol class="simple">
<li><p>测试2</p></li>
</ol>
<p>设备A发送配对广播，设备B扫描空中所有配对广播（不指定MAC），下面是设备B的电控日志：</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span>[2021-12-28 11:21:19.127] 发送数据: 
AA 0D FF F2 00 00 00 00 00 21 03 01 00 DD //开启配对广播扫描，扫描所有配对广播帧

[2021-12-28 11:21:19.216] 收到数据：
AA 0C FC F0 00 00 00 00 00 21 03 00 E4 

[2021-12-28 11:21:19.346] 收到数据：
AA 1E FC E2 00 00 0D 00 00 0D 01 03 00 01 01 A8 C0 00 01 01 00 00 00 03 00 00 01 00 00 00 76 //状态通知, 已开启扫描
消息类型：模组联网状态通知
蓝牙状态：已开启可连接广播 已开启扫描 

[2021-12-28 11:21:26.066] 收到数据：
AA 1F FC E3 00 00 0E 00 00 21 11 01 FC A3 1C 22 93 20 3C D4 0A 01 02 03 04 05 06 07 08 09 0A E0 //已扫描到设备A3 1C 22 93 20 3C的配对广播
</pre></div>
</div>
<blockquote>
<div><p>注意，标准模组电控口读取的MAC地址，数据流上是小端，但解析显示是大端。组本地联动电控帧时需要注意用小端。</p>
</div></blockquote>
</div>
</div>
<div class="section" id="id25">
<h1>家电找朋友<a class="headerlink" href="#id25" title="永久链接至标题"></a></h1>
<p>目前仅支持: 方案一,通过SoftAP的方式进行配网, 暂不支持BLE配网</p>
<p><img alt="msmart/image/MSmart%E5%8A%9F%E8%83%BD%E5%88%97%E8%A1%A8/1631527351106.png" src="msmart/image/MSmart%E5%8A%9F%E8%83%BD%E5%88%97%E8%A1%A8/1631527351106.png" /></p>
</div>
<div class="section" id="id26">
<h1>BLE协议关键字<a class="headerlink" href="#id26" title="永久链接至标题"></a></h1>
<hr class="docutils" />
<div class="section" id="id">
<h2>家庭ID<a class="headerlink" href="#id" title="永久链接至标题"></a></h2>
<p>家庭ID信息为家庭识别码，云端采用long数据类型进行定义，共8Byte。网桥和子设备的挂靠是基于同一家庭ID进行区分；</p>
</div>
<div class="section" id="id27">
<h2>设备ID<a class="headerlink" href="#id27" title="永久链接至标题"></a></h2>
<p>设备ID信息为设备识别码，云端采用long数据类型进行定义，共8Byte。子设备和云端通讯基于设备ID区分。</p>
</div>
<div class="section" id="id28">
<h2>绑定码<a class="headerlink" href="#id28" title="永久链接至标题"></a></h2>
<p>设备绑定码由外设随机生成，共16Byte。外设每次重置SDK或者重置设备绑定码时都应重新生成设备绑定码。</p>
</div>
</div>
<div class="section" id="part1-part2">
<h1>串口协议(Part1)与网络协议(Part2)的关系<a class="headerlink" href="#part1-part2" title="永久链接至标题"></a></h1>
<hr class="docutils" />
<p>这里以WB01-V2.1代码为例，说明串口命令与网络透传数据的关系。</p>
<ol class="simple">
<li><p>(串口收)<strong>==0x04, 0x06==</strong> 无应答 –&gt; MS_APP_MSG_NOTIFY_A2X_STAT_NOACK –&gt;  (用户) ENUM_MS_NETAPP_EVENT_REPORT_NOACK –&gt;(SDK)MS_NETWORK_CMD_DEVICE_UPDATE_STATUS(<strong>==0x0040==</strong>) - 模组发起，无需应答</p></li>
<li><p>(串口收)<strong>==0x05, 0x0A==</strong> 有应答 –&gt; MS_APP_MSG_NOTIFY_A2X_STAT –&gt;  (用户) ENUM_MS_NETAPP_EVENT_REPORT_ACK –&gt;(SDK)MS_NETWORK_CMD_DEVICE_ERROR(<strong>==0x0044==</strong>) - 模组发起需云端应答</p></li>
<li><p>(串口收) <strong>==0x02、0x03、0x11==</strong> 云端透传 –&gt; MS_APP_MSG_RESPONSE_A2X_TRANSDATA –&gt; (用户)ENUM_MS_NETAPP_EVENT_TRANS v –&gt; (SDK)MS_NETWORK_CMD_C2D_TRANSDATA(<strong>==0x8020==</strong>)  -  云端发起，模组只应答</p></li>
</ol>
</div>
<div class="section" id="id29">
<h1>模组日志 - 打开日志方法<a class="headerlink" href="#id29" title="永久链接至标题"></a></h1>
<p>烧录串口 接串口调试器 连接到电脑，波特率115200.</p>
<p>注意：</p>
<p>(1) 对于sit版本的固件，默认是所有的Log都开启。</p>
<p>(2) 对于正式版本的固件，默认只开启少量Log. 如果需要开启所有Log，需要在烧录串口发送</p>
<p>如下指令：AT+LOG “MAC+固件版本”</p>
<p>如：针对阿里 或者美居版本</p>
<p>其中二进制的组合格式：MAC地址 + 模组版本号， 比如：下面的意思是MAC:3C2093F70C6F, 固件版本号059006042118</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>AT+LOG 3C2093F70C6F059006042118 
//当成功时，则输出log_enable字样。
</pre></div>
</div>
<p>针对鸿蒙版本</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">AT</span><span class="o">+</span><span class="n">LOG</span><span class="o">=</span><span class="mi">502</span><span class="n">DBBF70F97059008012110</span>
</pre></div>
</div>
</div>
<div class="section" id="ble-ueccmbedtls">
<h1>BLE uECC与Mbedtls的关系<a class="headerlink" href="#ble-ueccmbedtls" title="永久链接至标题"></a></h1>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">//ms_sal_ble_common.c</span>
<span class="cp">#ifdef MS_CONFIG_UECC_SUPPORT </span><span class="c1">//如果定义了UECC，则使用UECC接口实现ECDH</span>
<span class="cp">#include</span> <span class="cpf">&quot;ms_uECC.h&quot; //UECC接口</span><span class="cp"></span>
<span class="kt">void</span> <span class="n">ms_sal_ble_ecdh_generate_keys_secp256r1</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="n">p_publicKey</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">p_privateKey</span><span class="p">)</span>
<span class="kt">void</span> <span class="n">ms_sal_ble_ecdh_shared_secret_secp256r1</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="n">p_publicKey</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">p_privateKey</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">p_sessionKey</span><span class="p">)</span>

<span class="cp">#else </span><span class="c1">//如果没有定义UECC，则使用MBEDTLS实现ECDH</span>
<span class="cp">#include</span> <span class="cpf">&quot;mbedtls/aes.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;mbedtls/rsa.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;mbedtls/ctr_drbg.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;mbedtls/entropy.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;mbedtls/ecdsa.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;mbedtls/ecp.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;mbedtls/ecdh.h&quot;</span><span class="cp"></span>
<span class="kt">void</span> <span class="n">ms_sal_ble_ecdh_generate_keys_secp256r1</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="n">p_publicKey</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">p_privateKey</span><span class="p">)</span>
<span class="kt">void</span> <span class="n">ms_sal_ble_ecdh_shared_secret_secp256r1</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="n">p_publicKey</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">p_privateKey</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">p_sessionKey</span><span class="p">)</span>
<span class="cp">#endif</span>
    
<span class="c1">//另外uECC也用于RCU和NT配网</span>
</pre></div>
</div>
<ul>
<li><p>什么是uECC？</p>
<p>ECC的英文全称是: Elliptic Curve Cryptography - 椭圆曲线<strong>密码学</strong>，是基于有限域的椭圆曲线和复杂的椭圆曲线离散对数.</p>
<p>ECC实现了非对称加密所需要的大部分能力，包括: 加密(encryption)、签名(signatures )、秘钥交换(key exchange).</p>
<p>ECC被认为是RSA密码系统的最好继承者，相对于RSA，ECC的keys更小，在于RSA相同等级下能够更快地生成Key
在ECC中，密钥生成就像在一定范围内安全地生成一个随机整数一样简单，所以这个过程非常的快.</p>
<p>ECC 中涉及的椭圆曲线中，非常出名的有，<strong>sepc256k1</strong>、Curve25519等.</p>
</li>
<li><p>什么是ECDH?</p>
<p>ECDH密钥协商<strong>算法</strong>基于椭圆曲线密码系统（ECC），使用较短的密钥长度可提供与RSA或DH算法同等的安全等级，密钥长度位160 ~ 256比特的椭圆曲线算法与密钥长度位1024 ~ 3072比特的非ECC算法安全强度相同</p>
<p>ECC算法用途比RSA还猛，不仅可以加解密、签名验证。还可以与DH结合使用，用于密钥磋商，这个密钥交换算法称为ECDH。</p>
<blockquote>
<div><p>ECC一种密码学算法，使数据安全，ECDH是基于ECC的一种密钥协商算法。</p>
</div></blockquote>
</li>
<li><p>mbedtls是什么？</p>
<blockquote>
<div><p>link:https://blog.csdn.net/chengjunchengjun/article/details/111348713</p>
<ul>
<li><p>先了解下SSL/TLS:  SSL和TLS指的是同一套加密协议，只是不同时期的名字差异。</p>
<p>1996年，在前面的基础上，SSL 3.0版问世并得到大规模应用（主要用于网络通信）</p>
<p>1999年，发布了SSL的升级版TLS 1.0版，也称为SSL 3.1；</p>
<p>2006年和2008年，TLS进行了两次升级，分别为TLS 1.1版和TLS 1.2版。</p>
<p>一般推荐使用TLS 1.2，主流的浏览器都支持。</p>
</li>
<li><p>再了解一下http和https</p>
<p>在SSL/TLS出现之前，很多应用层协议（http、ftp、smtp等）都存在着网络安全问题。最常见的http协议，在传输过程中使用的是明文信息。</p>
<p>应用层和传输层之间加入了SSL/TLS协议，升级为https协议（https协议的由来）</p>
</li>
<li><p>最后了解一下openSSL，互联网的加密库，功能强大但耗资源。</p></li>
</ul>
</div></blockquote>
<p>mbedtls开源加密库，功能类似openSSL，使用 C 编程语言以最小的编码占用空间实现了 SSL/TLS 功能及各种加密算法，易于理解、使用、集成和扩展，方便开发人员轻松地在嵌入式产品中使用 SSL/TLS 功能。其功能包括。</p>
<ul class="simple">
<li><p>完整的 SSL v3、TLS v1.0、TLS v1.1 和 TLS v1.2 协议实现</p></li>
<li><p>X.509 证书处理</p></li>
<li><p>基于 TCP 的 TLS 传输加密</p></li>
<li><p>基于 UDP 的 DTLS（Datagram TLS）传输加密</p></li>
<li><p><strong>其它加解密库实现 – （如ecdh）</strong></p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="id30">
<h1>BLE添加服务的流程<a class="headerlink" href="#id30" title="永久链接至标题"></a></h1>
<ol class="simple">
<li><p>FF80 - 添加服务</p></li>
<li><p>2803 - 特征声明 - 每添加一个特征值前先发送该声明给底层</p></li>
<li><p>FF81 - 特征值（可写有回调）</p></li>
<li><p>2901 - 特征值描述符</p></li>
<li><p>2803 - 特征声明 - （跟前面一样，声明下一个特征）</p></li>
<li><p>FF82 - 特征值 （notify）</p></li>
<li><p>2901 - [option]特征值描述符</p></li>
<li><p>2902 - 客户端描述符（特征值为notify属性时需要添加）</p></li>
<li><p>…</p></li>
</ol>
</div>
<div class="section" id="id31">
<h1>缩写<a class="headerlink" href="#id31" title="永久链接至标题"></a></h1>
<div class="section" id="prd-product-requirement-document">
<h2>PRD - 产品需求文档（Product Requirement Document）<a class="headerlink" href="#prd-product-requirement-document" title="永久链接至标题"></a></h2>
<hr class="docutils" />
<hr class="docutils" />
<hr class="docutils" />
<hr class="docutils" />
<hr class="docutils" />
<hr class="docutils" />
</div>
</div>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2022, maill.</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用了 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a>开发.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>